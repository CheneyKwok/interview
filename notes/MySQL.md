# MySQL

## MySQL 有哪几种数据存储引擎？有什么区别

通过 show engines 指令可以看到所有支持的数据存储引擎。最常用的是 MyISAM 和 InnoDB 两种

MyISAM 和 InnoDB 区别：

- 存储文件。MyISAM 每个表有三个个文件。mdy 表数据文件 、myi 索引文件和 sdi 表结构文件。而 InnoDB 每个表只有一个 idb 文件
- InnoDB 支持事务、支持行级锁、支持外键
- InnoDB 支持 XA 事务 (分布式事务协议) XA START/END/PREPARE/COMMIT
  - XA 事务就是两阶段提交的一种实现方式，定义了事务管理器 TM 和资源管理器 RM 之间的接口
  - prepare 阶段： TM 向所有 RM 发送 prepare 指令，RM 接受指令后执行数据修改和日志记录，返回是否可以提交给 TM
  - commit 阶段：TM 接受所有 RM 的 prepare 结果，如果所有 RM 均返回可以提交，则向所有 RM 发送事务提交命令，如果有 RM 返回不可提交或超时，则向所有 RM 发送事务回滚命令
- InnoDB 支持 Savepoints （提供一种部分回滚的机制)

## 什么是脏读、幻读、不可重复读？要怎么处理

脏读：一个事务读到另一个事务还没有提交的数据

不可重复读：一个事务多次读取同一条记录，读取的结果不同，update 引起

幻读：一个事务在查询数据时，没有对应的数据行，但是在插入数据时，这行数据又存在。insert 引起

处理的方式有很多种：加锁、事务隔离、MVCC

- 加锁
  
  脏读：在修改时加独占锁，直达事务提交才释放。读取时加共享锁，读完释放

  不可重复读：读数据时加共享锁，写数据时加独占锁，行锁

  幻读：加范围锁，表锁

## 事务的基本特性和隔离级别有哪些

事务：表示多个数据操作组成一个完整的事务单元，这个事务内的所有数据操作要么同时成功，要么同时失败

事务的特性：ACID

1、原子性: 事务是不可分割的，要么完全成功，要么完全失败

2、一致性：事务完成时，必须使所有的数据都保持一致状态

3、隔离性：数据库提供的隔离机制，保证事务不受外部并发操作的影响下隔离运行

4、持久性：事务一旦提交或回滚，它对数据库中的数据的改变是永久的

事务的隔离级别

指令 show VARIABLES like 'TRANSACTION%'

set transaction level xxx 设置下次事务的隔离级别
set session transaction level xxx 设置当前会话的事务的隔离级别
set global transaction level xxx 设置全局事务隔离级别

MySQL 中有五种隔离级别

NONE: 不使用事务
READ UNCOMMITED：允许脏读
READ COMMITED：防止脏读，最常用的隔离级别
REPEATABLE READ: 防止脏读和不可重读。MySQL 默认
SERIALIZABLE：事务串行，可以防止脏读、幻读、不可重复读

五种隔离级别，级别越高，事务的安全性更高，但是并发的性能越低

## 为什么 InnoDB 存储引擎选择使用 B+tree 索引结构

B-tree：一个最大度数(一个节点的子节点个数)为 5 的 B-tree，每个节点最多存储 4 个 key，5 个指针

B+ tree：所有的数据都保存在叶子节点；叶子节点形成了一个单向链表；MySQL进行了优化，叶子节点形成了双向链表

- 相对于二叉树搜索数和红黑树，层级更少，搜索效率高
- 对于 B-tree，无论是叶子节点还是非叶子节点，都会存储数据，这样导致一页(16kb)中存储的键值减少，指针跟着减少，树的高度增加，导致性能降低；而且 B+ tree； 中叶子节点形成了双向链表，便于范围搜索和排序
- 对于 Hash 索引，只支持等值匹配，不支持范围搜索和排序
